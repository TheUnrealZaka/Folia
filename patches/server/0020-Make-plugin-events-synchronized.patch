From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: TheUnrealZaka <info@theunrealzaka.me>
Date: Sat, 07 Sep 2024 00:29:43 +0200
Subject: [PATCH] Make plugin events synchronized.

To fix some plugins that claim Folia compatibility, but in reality fail at multithreading.

diff --git a/src/main/java/io/papermc/paper/plugin/manager/PaperEventManager.java b/src/main/java/io/papermc/paper/plugin/manager/PaperEventManager.java
index 7ce9ebba8ce304d1f3f21d4f15ee5f3560d7700b..1b5ec4e11eaa4ec837ef4c64af48cd3acc379d2b 100644
--- a/src/main/java/io/papermc/paper/plugin/manager/PaperEventManager.java
+++ b/src/main/java/io/papermc/paper/plugin/manager/PaperEventManager.java
@@ -29,6 +29,7 @@ import java.util.logging.Level;
 class PaperEventManager {
 
     private final Server server;
+    public static final Object lock = new Object(); // Folia
 
     public PaperEventManager(Server server) {
         this.server = server;
@@ -51,6 +52,13 @@ class PaperEventManager {
             }
 
             try {
+                // Folia start
+                    synchronized (lock) { // Folia - never run plugins async
+                        registration.callEvent(event);
+                    }
+                } else
+                // Folia end
                 registration.callEvent(event);
             } catch (AuthorNagException ex) {
                 Plugin plugin = registration.getPlugin();
